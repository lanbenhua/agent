!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Agent={})}(this,(function(e){"use strict";var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},t(e,n)};function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=function(){function e(){this.handlers=[],this.handlers=[]}return e.prototype.use=function(e,t,n){return this.handlers=this.handlers.concat({onFulfilled:e,onRejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1},e.prototype.reject=function(e){this.handlers[e]&&(this.handlers[e]=null)},e.prototype.forEach=function(e){this.handlers.forEach((function(t,n){null!==t&&e(t,n)}))},e}(),i=function(e,t,n){try{return JSON.stringify(e,t,n)}catch(e){return""}};function u(e){return null==e}
/*!
     * is-plain-object <https://github.com/jonschlinkert/is-plain-object>
     *
     * Copyright (c) 2014-2017, Jon Schlinkert.
     * Released under the MIT License.
     */function s(e){return"[object Object]"===Object.prototype.toString.call(e)}function c(e){return!!s(e)&&(void 0===e.constructor||!!s(e.constructor.prototype)&&!!e.constructor.prototype.hasOwnProperty("isPrototypeOf"))}var a=function(){function e(e){this._contentType=e}return e.prototype.marshal=function(e){var t=this._contentType;if("formdata"===t)return function(e){if(e instanceof FormData)return e;var t=new FormData;c(e)&&Object.entries(e).forEach((function(e){var n=e[0],r=e[1];u(r)||(Array.isArray(r)&&r.forEach((function(e){u(e)||t.append(n,f(e))})),t.append(n,f(r)))}));"string"==typeof e&&new URLSearchParams(e).forEach((function(e,n){t.append(n,e)}));return t}(e);if("json"===t)return"string"==typeof e?e:i(e);if("form"===t)return function(e){if("string"==typeof e)return e;if(e instanceof URLSearchParams)return e.toString();if(c(e))return p(e);if(e instanceof FormData){var t={};return e.forEach((function(e,n){t[n]=e})),p(t)}return""}(e);if("blob"===t){if(!(e instanceof Blob))throw new Error("BodyParser: must be a blob when content type is blob");return e}if("buffer"===t){if(!(e instanceof ArrayBuffer))throw new Error("BodyParser: must be a arraybuffer when content type is arraybuffer");return e}return"text"===t?"string"==typeof e?e:i(e):e},e}();function p(e){return Object.entries(e).reduce((function(e,t){var n=t[0],r=t[1];return u(r)?e:Array.isArray(r)?(r.forEach((function(t){u(t)||e.append(n,f(t))})),e):(e.append(n,f(r)),e)}),new URLSearchParams).toString()}function f(e){return u(e)?"":"string"==typeof e?e:"number"==typeof e||"boolean"==typeof e?String(e):i(e)}var h=function(){function e(e){this._priority=0,this._priority=e||0}return e.prototype.num=function(){var e=this._priority;return null==e?0:"HIGHEST"===e?Number.MAX_SAFE_INTEGER:"HIGH"===e?1e4:"MEDIUM"===e?0:"LOW"===e?-1e4:"LOWEST"===e?Number.MIN_SAFE_INTEGER:e},e}(),l=function(e){function t(t,n,r){var o=e.call(this,t)||this;return o.custom=!0,o.type="CustomError",o.type=n||"CustomError",o.name=r||"CustomError",o.message=t||"Invalid",o}return n(t,e),t.prototype.toString=function(e){return 1===e?"".concat(this.name,": ").concat(this.message):2===e?"".concat(this.message):"[".concat(this.type,"] ").concat(this.name,": ").concat(this.message)},t}(Error),d=function(e){function t(t,n){var r=e.call(this,t,"CancelError",n)||this;return r.type="CancelError",r}return n(t,e),t}(l);var y={auto:!0},_=function(){function e(e,t){this._pending=0,this._concurrency=10,this._queue=[],this._isPaused=!1,this._queue=[],this._pending=0,this._options=r(r({},y),t),this._resolve=this._resolve.bind(this),this._reject=this._reject.bind(this),this.reconcurrency(e)}return Object.defineProperty(e.prototype,"size",{get:function(){return this._queue.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"concurrency",{get:function(){return this._concurrency},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pending",{get:function(){return this._pending},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isPaused",{get:function(){return this._isPaused},enumerable:!1,configurable:!0}),e.prototype.pause=function(){this._isPaused=!0},e.prototype.resume=function(){var e;this._isPaused=!1,(null===(e=this._options)||void 0===e?void 0:e.auto)&&this._check()},e.prototype.reconcurrency=function(e){var t;this._concurrency=e,(null===(t=this._options)||void 0===t?void 0:t.auto)&&this._check()},e.prototype.enqueue=function(e){var t,n=this,o=e.runner,i=new Promise((function(i,u){t=r(r({},e),{runner:o,resolve:i,reject:u}),n._push(t)})).then(this._resolve,this._reject);return i.cancel=function(){n._cancel(t)},i},e.prototype.dequeue=function(){this._check()},e.prototype._check=function(){this._pending>=this.size||this._queue.length<1||(this._run(),this._check())},e.prototype._cancel=function(e){(0,e.reject)(new d("Canceled","QueueCancelError"))},e.prototype._run=function(){var e=this._queue.shift();if(e){this._pending++;var t=e.runner,n=e.resolve,r=e.reject;t().then(n,r)}},e.prototype._push=function(e){this._queue=this._queue.concat(e).sort((function(e,t){return new h(t.priority).num()-new h(e.priority).num()})),this._check()},e.prototype._pop=function(){if(this._pending--,this._pending<0)throw new Error("Pop called more than there were pending fetches");this._check()},e.prototype._resolve=function(e){return this._pop(),e},e.prototype._reject=function(e){throw this._pop(),e},e}(),v=window.fetch,b={json:"application/json; charset=utf-8",form:"application/x-www-form-urlencoded; charset=utf-8",formdata:void 0,buffer:"text/plain; charset=utf-8",text:"text/plain; charset=utf-8",blob:void 0},m={timeout:6e4},g={},w="default",E=function(){function e(e,t){this._interceptors={request:new o,response:new o},this._base=e,this._init=r(r({},m),t),this._initQueues(),this._request=this._request.bind(this),this._dispatchFetch=this._dispatchFetch.bind(this)}return Object.defineProperty(e.prototype,"init",{get:function(){return this._init},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"base",{get:function(){return this._base},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"queues",{get:function(){return this._queues},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"interceptors",{get:function(){return this._interceptors},enumerable:!1,configurable:!0}),e.prototype.queue=function(e){var t;return null===(t=this._queues)||void 0===t?void 0:t.get(e)},e.prototype._initQueues=function(){var e=this;if(this._init&&this._init.queue){var t=this._init.queue,n=t.concurrency,r=t.defaultName,o=t.concurrencies;(n||r)&&this._createOrGetQueue(r,n),o&&Object.entries(o).map((function(t){var n=t[0],r=t[1];e._createOrGetQueue(n,r)}))}},e.prototype._createOrGetQueue=function(e,t){void 0===e&&(e=w),void 0===t&&(t=5),this._queues||(this._queues=new Map);var n=this.queue(e);if(n)return n;var r=new _(t);return this._queues.set(e,r),r},e.prototype.request=function(e){var t,n,r,o,i,u,s,c,a,p,f=this;if(this._queues){var h=null!==(i=null!==(n=null===(t=e.queue)||void 0===t?void 0:t.name)&&void 0!==n?n:null===(o=null===(r=this._init)||void 0===r?void 0:r.queue)||void 0===o?void 0:o.defaultName)&&void 0!==i?i:w,l=null!==(c=null===(s=null===(u=this._init)||void 0===u?void 0:u.queue)||void 0===s?void 0:s.concurrency)&&void 0!==c?c:5;return this._createOrGetQueue(h,l).enqueue({runner:function(){return f._request(e)},priority:null!==(p=null===(a=e.queue)||void 0===a?void 0:a.priority)&&void 0!==p?p:"MEDIUM"})}return this._request(e)},e.prototype._request=function(e){this._resolveInput(e);var t=this._resolveReqInit(e);return this._resolveTimeoutAutoAbort(t),this._handleInterceptors(t)},e.prototype._resolveInput=function(e){var t,n=q(this._base||(null==e?void 0:e.base),e.input);if("GET"===(null===(t=null==e?void 0:e.method)||void 0===t?void 0:t.toUpperCase())&&(null==e?void 0:e.data)){var r=n.indexOf("?"),o=r<0?n:n.slice(0,n.indexOf("?")),i=O(r<0?"":n.slice(n.indexOf("?")),null==e?void 0:e.data);n=o+(i?"?".concat(i):"")}e.url=n},e.prototype._resolveReqInit=function(e){var t,n=r(r(r({},g),{timeout:null===(t=this._init)||void 0===t?void 0:t.timeout}),e);n.method||(n.method="GET"),n.method=n.method.toUpperCase();var o=(null==n?void 0:n.contentType)&&b[null==n?void 0:n.contentType],i=r({},o?{"Content-Type":o}:null);return n.headers=r(r(r({},g.headers),i),n.headers),n.body="GET"===n.method||"HEAD"===n.method?void 0:void 0!==n.body&&null!==n.body?n.body:new a(null==n?void 0:n.contentType).marshal(n.data),n},e.prototype._resolveTimeoutAutoAbort=function(e){var t=e.timeout;if(t&&!e.signal){var n=new AbortController;n.signal.addEventListener("abort",(function(e){console.log("ev",e,n.signal,n.signal.aborted,n.signal.reason)})),e.abortController=n,e.signal=n.signal;var r=setTimeout((function(){n.abort("Timeout of exceeded"),clearTimeout(r)}),t)}},e.prototype._handleInterceptors=function(e){var t=[],n=!0;this._interceptors.request.forEach((function(r){var o=r.runWhen,i=r.onFulfilled,u=r.onRejected;"function"==typeof o&&!1===o(e)||(n=n&&r.synchronous,t.unshift(i,u))}));var r,o=[];if(this._interceptors.response.forEach((function(e){return o.unshift(e.onFulfilled,e.onRejected)})),!n){var i=[this._dispatchFetch,void 0];for(Array.prototype.unshift.apply(i,t),i=i.concat(o),r=Promise.resolve(e);i.length;){var u=i.shift(),s=i.shift();u&&(r=r.then(u,s))}return r}for(var c=e;t.length;){u=t.shift(),s=t.shift();try{u&&(c=u(c))}catch(e){s&&s(e);break}}for(var a=this._dispatchFetch(c);o.length;){u=o.shift(),s=o.shift();u&&(a=a.then(u,s))}return a},e.prototype._dispatchFetch=function(e){var t,n=this,r=e.url||e.input;return r?v(r,e).then((function(r){t=r;var o=n._checkResponseType(r,e.responseType);if("json"===o)return r.json();if("buffer"===o)return r.arrayBuffer();if("text"===o)return r.text();if("blob"===o)return r.blob();if("form"===o||"formdata"===o)return r.formData();throw new Error("Agent: unexcepted response type '".concat(o,"'"))})).then((function(r){return n._decorateResponse(e,t,r)})):Promise.reject(new Error("Agent: unexpected error, url must have a value and be a string, but null!"))},e.prototype._checkResponseType=function(e,t){var n=j(e);if(!t&&!n)throw new Error("Agent: except a response type but null");if(n&&t&&n!==t)throw new Error("Agent: except a '".concat(t,"' response type but '").concat(n,"'"));return t||n},e.prototype._decorateResponse=function(e,t,n){return{data:n,url:t.url,ok:t.ok,status:t.status,statusText:t.statusText,headers:t.headers,__init__:e,__agent__:this,__response__:t}},e}(),j=function(e){var t=e.headers.get("content-type");if(t)return(null==t?void 0:t.includes("application/json"))?"json":(null==t?void 0:t.includes("text/plain"))||(null==t?void 0:t.includes("text/html"))||(null==t?void 0:t.includes("application/xml"))?"text":void 0},q=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=/(?<!(https?|file|wss?):)\/\/+/,r=/^(https?|file|wss?):\/\//;return e.filter(Boolean).map(String).reduce((function(e,t){return new RegExp(r).test(t)?t:e+"/"+t})).replace(new RegExp(n,"gm"),"/")};function O(e,t){var n=new URLSearchParams(e),r=new a("form").marshal(t),o=new URLSearchParams("?"+r);return o.forEach((function(e,t){null!=e&&n.append(t,e)})),o.toString()}e.CustomCancelError=d,e.CustomError=l,e.Queue=_,e.default=E,e.isCustomCancelError=function(e){return e.custom&&"CancelError"===e.type},e.isCustomError=function(e){return e.custom},Object.defineProperty(e,"__esModule",{value:!0})}));
